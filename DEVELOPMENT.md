# 开发者指南

## 🔐 开发时的权限问题

### 问题说明
在 Xcode 中开发时，每次重新构建应用，macOS 会认为这是一个"新应用"（因为签名变化），导致：
- ✅ 麦克风权限保留（系统级权限）
- ❌ 辅助功能权限失效（需要重新授权）

这是 macOS 的安全机制，是正常现象。

---

## 解决方案

### 方案 1：自动重试机制 ✨（已实现）

应用已内置**自动重试机制**：
- 启动失败后，每 10 秒自动重试一次
- 最多重试 3 次
- 授权后无需重启应用

**使用流程：**
1. 运行应用（⌘R）
2. 看到权限提示 → 点击「打开系统设置」
3. 在系统设置中授权 voice-now
4. **无需重启应用**，等待 10 秒自动重连
5. 看到日志 `⌨️ 全局快捷键监听已启动` 表示成功

---

### 方案 2：手动刷新权限

在主界面点击**「刷新权限状态」**按钮，检查权限是否生效。

---

### 方案 3：配置开发者签名（一劳永逸）

如果您有 Apple 开发者账号：

1. **在 Xcode 中配置团队**
   - 打开项目设置
   - 选择 Target: voice-now
   - 在 "Signing & Capabilities" 标签页
   - 选择您的 Team

2. **使用相同的 Bundle Identifier**
   - 确保每次构建使用相同的 Bundle ID
   - 当前：`com.lakphy.voice-now`

3. **配置后的效果**
   - ✅ 每次构建签名稳定
   - ✅ 权限只需授予一次
   - ✅ 开发体验更好

---

### 方案 4：使用 Archive 构建（发布时）

发布正式版本时：

1. **Archive 应用**
   ```
   Product → Archive
   ```

2. **导出应用**
   - Development
   - 或 Ad Hoc（给测试用户）

3. **安装到 Applications 文件夹**
   - 移动到 `/Applications/voice-now.app`
   - 这样签名会更稳定

---

## 🚀 推荐的开发工作流

### 日常开发
```bash
# 1. 运行应用
⌘R

# 2. 首次运行 → 授予权限
#    打开系统设置 → 授权 voice-now

# 3. 等待 10 秒，应用自动重连
#    或点击「刷新权限状态」

# 4. 开始开发和测试
#    代码修改后重新运行（⌘R）
#    如果权限失效，重复步骤 2-3
```

### 测试发布版本
```bash
# 1. Archive
Product → Archive

# 2. 导出到桌面
Distribute App → Development

# 3. 安装
移动到 /Applications/

# 4. 运行并测试
正式版权限会保留
```

---

## 🐛 常见问题

### Q1: 为什么开发时权限总是失效？
**A:** 这是正常的。每次 ⌘R 运行，应用签名都会变化，系统认为是新应用。

**解决：** 使用自动重试机制（已内置），或配置开发者签名。

---

### Q2: 如何快速测试权限是否生效？
**A:** 
1. 点击主界面的「刷新权限状态」
2. 或查看控制台日志是否显示 `⌨️ 全局快捷键监听已启动`

---

### Q3: 自动重试不工作怎么办？
**A:** 
1. 确保在系统设置中已正确授权
2. 手动点击「刷新权限状态」
3. 或重启应用（⌘Q 后再 ⌘R）

---

### Q4: 能否跳过权限直接开发？
**A:** 不能。辅助功能权限是全局快捷键的必要条件。

**替代方案：** 开发时可以：
- 使用主窗口的「测试识别」按钮（不需要权限）
- 临时注释掉全局快捷键相关代码

---

## 📝 开发调试日志

### 成功启动的日志
```
🚀 应用已启动
🚀 启动应用协调器
🎤 麦克风权限: 已授予
⌨️ 全局快捷键监听已启动  ← 看到这个表示成功
```

### 权限失效时的日志
```
🚀 应用已启动
🚀 启动应用协调器
❌ 全局快捷键监听启动失败 - 需要在「系统设置 > 隐私与安全性 > 辅助功能」中授权
🔄 将在 10 秒后自动重试... (第 1/3 次)  ← 自动重试
```

### 授权后自动重连的日志
```
🔄 将在 10 秒后自动重试... (第 1/3 次)
⌨️ 全局快捷键监听已启动  ← 重试成功！
```

---

## 💡 最佳实践

1. **首次开发时**
   - 花 1 分钟正确配置权限
   - 之后可以使用自动重试

2. **频繁修改时**
   - 使用「测试识别」按钮测试核心功能
   - 全局快捷键功能定期测试即可

3. **准备发布时**
   - 使用 Archive 构建
   - 配置正确的签名和证书
   - 在多台机器上测试

---

## 🎯 快捷键参考

| 操作 | 快捷键 |
|------|--------|
| 运行应用 | ⌘R |
| 停止应用 | ⌘. |
| 退出应用 | ⌘Q |
| 清理构建 | ⌘⇧K |
| 打开控制台 | ⌘⇧Y |
| 打开设置 | ⌘, |

---

## 📚 相关文档

- [README.md](README.md) - 用户使用文档
- [QUICKSTART.md](QUICKSTART.md) - 快速开始指南
- [DEBUG.md](DEBUG.md) - 调试指南

---

祝开发愉快！🎉

